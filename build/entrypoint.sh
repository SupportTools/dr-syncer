#!/bin/bash
set -e

# Enhanced log function that writes to both stdout and log file
log() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    local message="[${timestamp}] [ENTRYPOINT] $1"
    echo "${message}" | tee -a /var/log/console.log
}

log "Starting DR-Syncer RSYNC container initialization (Ubuntu)"

# Set up log directories
mkdir -p /var/log
log "Created log directory"

# Initialize log files
touch /var/log/console.log /var/log/ssh-command-handler.log
chmod 644 /var/log/console.log /var/log/ssh-command-handler.log
log "Initialized log files"

# Host keys are provided by the controller in the secret or generated by ssh-keygen -A
log "Setting up SSH host keys"
mkdir -p /etc/ssh/host_keys

# Copy and set permissions for SSH keys if provided (overrides generated keys)
if [ -f /etc/ssh/keys/ssh_host_rsa_key ]; then
    cp /etc/ssh/keys/ssh_host_rsa_key /etc/ssh/host_keys/
    cp /etc/ssh/keys/ssh_host_rsa_key.pub /etc/ssh/host_keys/
    chmod 600 /etc/ssh/host_keys/ssh_host_rsa_key
    chmod 644 /etc/ssh/host_keys/ssh_host_rsa_key.pub
    # Link to location expected by Ubuntu SSH
    cp /etc/ssh/keys/ssh_host_rsa_key /etc/ssh/
    cp /etc/ssh/keys/ssh_host_rsa_key.pub /etc/ssh/
    chmod 600 /etc/ssh/ssh_host_rsa_key
    chmod 644 /etc/ssh/ssh_host_rsa_key.pub
    log "Installed RSA host key"
fi

if [ -f /etc/ssh/keys/ssh_host_ecdsa_key ]; then
    cp /etc/ssh/keys/ssh_host_ecdsa_key /etc/ssh/host_keys/
    cp /etc/ssh/keys/ssh_host_ecdsa_key.pub /etc/ssh/host_keys/
    chmod 600 /etc/ssh/host_keys/ssh_host_ecdsa_key
    chmod 644 /etc/ssh/host_keys/ssh_host_ecdsa_key.pub
    # Link to location expected by Ubuntu SSH
    cp /etc/ssh/keys/ssh_host_ecdsa_key /etc/ssh/
    cp /etc/ssh/keys/ssh_host_ecdsa_key.pub /etc/ssh/
    chmod 600 /etc/ssh/ssh_host_ecdsa_key
    chmod 644 /etc/ssh/ssh_host_ecdsa_key.pub
    log "Installed ECDSA host key"
fi

if [ -f /etc/ssh/keys/ssh_host_ed25519_key ]; then
    cp /etc/ssh/keys/ssh_host_ed25519_key /etc/ssh/host_keys/
    cp /etc/ssh/keys/ssh_host_ed25519_key.pub /etc/ssh/host_keys/
    chmod 600 /etc/ssh/host_keys/ssh_host_ed25519_key
    chmod 644 /etc/ssh/host_keys/ssh_host_ed25519_key.pub
    # Link to location expected by Ubuntu SSH
    cp /etc/ssh/keys/ssh_host_ed25519_key /etc/ssh/
    cp /etc/ssh/keys/ssh_host_ed25519_key.pub /etc/ssh/
    chmod 600 /etc/ssh/ssh_host_ed25519_key
    chmod 644 /etc/ssh/ssh_host_ed25519_key.pub
    log "Installed ED25519 host key"
fi

# Create required SSH directories for Ubuntu
mkdir -p /var/run/sshd
chmod 0755 /var/run/sshd
log "Created SSH daemon directories"

# Create data directory
log "Creating data directory"
mkdir -p /data
chmod 755 /data

# Set up log streaming
log "Setting up log streaming to container stdout"

# Function to monitor and stream log files
stream_logs() {
    local log_file="$1"
    local prefix="$2"
    touch "${log_file}"
    # Use tail -F to follow the file even if it's recreated
    tail -F "${log_file}" | while read -r line; do
        echo "${prefix}${line}"
    done &
}

# Stream both log files with prefixes
stream_logs "/var/log/ssh-command-handler.log" "[SSH-HANDLER] " 
stream_logs "/var/log/console.log" "[CONSOLE] " 
stream_logs "/var/log/auth.log" "[AUTH] " 2>/dev/null || true

log "Starting SSH daemon in debug mode"
# Start sshd in debug mode to get more verbose output
exec /usr/sbin/sshd -D -e -E /var/log/console.log
